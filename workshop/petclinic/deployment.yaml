---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
      annotations:
        instrumentation.opentelemetry.io/inject-java: "default/splunk-otel-collector"
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - name: config-server
          image: quay.io/phagen/spring-petclinic-config-server:0.0.2
          imagePullPolicy: Always
          ports:
            - containerPort: 8888
          volumeMounts:
            - name: petclinic-repo
              mountPath: /petclinic-repo
              readOnly: true
          env:
            - name: _JAVA_OPTIONS
              value: "-Dspring.profiles.active=native -DGIT_REPO=/petclinic-repo -Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
      volumes:
        - name: petclinic-repo
          hostPath:
            path: /home/splunk/workshop/petclinic/petclinic-repo
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: config-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: config-server
  ports:
    - name: tcp
      port: 8888
      targetPort: 8888
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: discovery-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: discovery-server
  template:
    metadata:
      labels:
        app: discovery-server
      annotations:
        instrumentation.opentelemetry.io/inject-java: "default/splunk-otel-collector"
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://config-server:8888
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-discovery-server:0.0.2
          name: discovery-server
          imagePullPolicy: Always
          ports:
            - containerPort: 8761
          env:
            - name: JAVA_OPTIONS
              value: "-Xdebug -Dsplunk.profiler.call.stack.interval=150"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: discovery-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: discovery-server
  ports:
    - name: tcp
      port: 8761
      targetPort: 8761
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
      annotations:
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          name: api-gateway
          image: quay.io/phagen/spring-petclinic-api-gateway:0.0.7
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAVA_OPTIONS
              value: "-Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: RUM_REALM
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: realm
            - name: RUM_AUTH
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: rum_token
            - name: RUM_APP_NAME
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: app
            - name: RUM_ENVIRONMENT
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: env
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 82
      targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway-external
  labels:
    app.kubernetes.io/part-of: spring-petclinic
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "5"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "3"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
    external-dns.alpha.kubernetes.io/hostname: demo.
spec:
  type: LoadBalancer
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 81
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: customers-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: customers-service
  template:
    metadata:
      labels:
        app: customers-service
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-customers-service:0.0.2
          name: customers-service
          imagePullPolicy: Always
          ports:
            - containerPort: 8081
          env:
            - name: _JAVA_OPTIONS
              value: "-Dspring.profiles.active=docker,mssql -Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: customers-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: customers-service
  ports:
    - name: tcp
      port: 8081
      targetPort: 8081
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vets-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: vets-service
  template:
    metadata:
      labels:
        app: vets-service
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-vets-service:0.0.2
          name: vets-service
          imagePullPolicy: Always
          ports:
            - containerPort: 8083
          env:
            - name: _JAVA_OPTIONS
              value: "-Dspring.profiles.active=docker,mssql -Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: vets-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: vets-service
  ports:
    - name: tcp
      port: 8083
      targetPort: 8083
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: visits-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: visits-service
  template:
    metadata:
      labels:
        app: visits-service
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-visits-service:0.0.2
          name: visits-service
          imagePullPolicy: Always
          ports:
            - containerPort: 8082
          env:
            - name: _JAVA_OPTIONS
              value: "-Dspring.profiles.active=docker,mssql -Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: visits-service
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: visits-service
  ports:
    - name: tcp
      port: 8082
      targetPort: 8082
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: admin-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: admin-server
  template:
    metadata:
      labels:
        app: admin-server
      annotations:
        instrumentation.opentelemetry.io/inject-java: "default/splunk-otel-collector"
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-admin-server:0.0.2
          name: admin-server
          imagePullPolicy: Always
          ports:
            - containerPort: 9090
          env:
            - name: OTEL_INSTRUMENTATION_SPLUNK_JDBC_ENABLED
              value: "true"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: admin-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: admin-server
  ports:
    - name: tcp
      port: 9090
      targetPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: petclinic-db
spec:
  ports:
    - port: 1433
  selector:
    app: petclinic-db
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: petclinic-db
spec:
  selector:
    matchLabels:
      app: petclinic-db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: petclinic-db
    spec:
      containers:
        - image: mcr.microsoft.com/mssql/server:2022-latest
          name: petclinic-db
          env:
            - name: ACCEPT_EULA
              value: "Y"
            - name: SA_PASSWORD
              value: "Petclinic1!"
          ports:
            - containerPort: 1433
              name: petclinic-db
          volumeMounts:
            - name: petclinic-db-persistent-storage
              mountPath: /var/opt/mssql
            - name: petclinic-db-initdb
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: petclinic-db-persistent-storage
        - name: petclinic-db-initdb
          configMap:
            name: petclinic-db-initdb-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: petclinic-db-initdb-config
data:
  initdb.sql: |
    -- [T-SQL init script from previous message, fully included here]
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway-ingress
spec:
  ingressClassName: traefik
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 82
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: petclinic-loadgen-deployment
  labels:
    app: petclinic-loadgen
spec:
  replicas: 1
  selector:
    matchLabels:
      app: petclinic-loadgen
  template:
    metadata:
      labels:
        app: petclinic-loadgen
    spec:
      containers:
        - name: petclinic-loadgen
          image: ghcr.io/splunk/online-boutique/rumloadgen:5.6
          imagePullPolicy: Always
          env:
            - name: RUM_FRONTEND_IP
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: url
          volumeMounts:
            - name: puppeteer
              subPath: local-file
              mountPath: /puppeteer/touchwebsite.js
      volumes:
        - name: puppeteer
          configMap:
            name: scriptfile
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scriptfile
data:
  local-file: |
    # [Puppeteer script unchanged from original YAML]
