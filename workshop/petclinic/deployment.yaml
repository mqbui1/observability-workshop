---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
      annotations:
        instrumentation.opentelemetry.io/inject-java: "default/splunk-otel-collector"
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - name: config-server
          image: quay.io/phagen/spring-petclinic-config-server:0.0.2
          imagePullPolicy: Always
          ports:
            - containerPort: 8888
          volumeMounts:
            - name: petclinic-repo
              mountPath: /petclinic-repo
              readOnly: true
          env:
            - name: _JAVA_OPTIONS
              value: "-Dspring.profiles.active=native -DGIT_REPO=/petclinic-repo -Xdebug -Dsplunk.profiler.call.stack.interval=150"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
      volumes:
        - name: petclinic-repo
          hostPath:
            path: /home/splunk/workshop/petclinic/petclinic-repo
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: config-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: config-server
  ports:
    - name: tcp
      port: 8888
      targetPort: 8888
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: discovery-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: discovery-server
  template:
    metadata:
      labels:
        app: discovery-server
      annotations:
        instrumentation.opentelemetry.io/inject-java: "default/splunk-otel-collector"
    spec:
      terminationGracePeriodSeconds: 5
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://config-server:8888
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          image: quay.io/phagen/spring-petclinic-discovery-server:0.0.2
          name: discovery-server
          imagePullPolicy: Always
          ports:
            - containerPort: 8761
          env:
            - name: JAVA_OPTIONS
              value: "-Xdebug -Dsplunk.profiler.call.stack.interval=150"
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: discovery-server
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: discovery-server
  ports:
    - name: tcp
      port: 8761
      targetPort: 8761
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
      annotations:
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
    spec:
      containers:
        - command:
            - ./dockerize
            - -wait=tcp://discovery-server:8761
            - -timeout=60s
            - --
            - java
            - org.springframework.boot.loader.JarLauncher
          name: api-gateway
          image: quay.io/phagen/spring-petclinic-api-gateway:0.0.7
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAVA_OPTIONS
              value: "-Xdebug -Dsplunk.profiler.call.stack.interval=150"
            - name: RUM_REALM
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: realm
            - name: RUM_AUTH
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: rum_token
            - name: RUM_APP_NAME
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: app
            - name: RUM_ENVIRONMENT
              valueFrom:
                secretKeyRef:
                  name: workshop-secret
                  key: env
          resources:
            requests:
              memory: 512Mi
            limits:
              memory: 768Mi
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  labels:
    app.kubernetes.io/part-of: spring-petclinic
spec:
  type: ClusterIP
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 82
      targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway-external
  labels:
    app.kubernetes.io/part-of: spring-petclinic
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "5"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "3"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
    external-dns.alpha.kubernetes.io/hostname: demo.
spec:
  type: LoadBalancer
  selector:
    app: api-gateway
  ports:
    - name: http
      port: 81
      targetPort: 8080
---
# ------------------------
# SQL Server Database
# ------------------------
apiVersion: v1
kind: Service
metadata:
  name: petclinic-db
spec:
  ports:
    - port: 1433
  selector:
    app: petclinic-db
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: petclinic-db
spec:
  selector:
    matchLabels:
      app: petclinic-db
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: petclinic-db
    spec:
      containers:
        - image: mcr.microsoft.com/mssql/server:2019-latest
          name: petclinic-db
          env:
            - name: SA_PASSWORD
              value: "YourStrong!Passw0rd"
            - name: ACCEPT_EULA
              value: "Y"
            - name: MSSQL_PID
              value: "Express"
          ports:
            - containerPort: 1433
              name: petclinic-db
          volumeMounts:
            - name: petclinic-db-persistent-storage
              mountPath: /var/opt/mssql
            - name: petclinic-db-initdb
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: petclinic-db-persistent-storage
        - name: petclinic-db-initdb
          configMap:
            name: petclinic-db-initdb-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: petclinic-db-initdb-config
data:
  initdb.sql: |
    -- SQL Server T-SQL init script
    IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'petclinic')
    BEGIN
        CREATE DATABASE petclinic;
    END
    GO

    USE petclinic;
    GO

    CREATE TABLE types (
        id INT IDENTITY(1,1) PRIMARY KEY,
        name NVARCHAR(80)
    );
    GO

    CREATE TABLE owners (
        id INT IDENTITY(1,1) PRIMARY KEY,
        first_name NVARCHAR(30),
        last_name NVARCHAR(30),
        address NVARCHAR(255),
        city NVARCHAR(80),
        telephone NVARCHAR(20)
    );
    GO

    CREATE TABLE pets (
        id INT IDENTITY(1,1) PRIMARY KEY,
        name NVARCHAR(30),
        birth_date DATE,
        type_id INT NOT NULL,
        owner_id INT NOT NULL,
        CONSTRAINT FK_pets_owner FOREIGN KEY(owner_id) REFERENCES owners(id),
        CONSTRAINT FK_pets_type FOREIGN KEY(type_id) REFERENCES types(id)
    );
    GO

    CREATE TABLE vets (
        id INT IDENTITY(1,1) PRIMARY KEY,
        first_name NVARCHAR(30),
        last_name NVARCHAR(30)
    );
    GO

    CREATE TABLE specialties (
        id INT IDENTITY(1,1) PRIMARY KEY,
        name NVARCHAR(80)
    );
    GO

    CREATE TABLE vet_specialties (
        vet_id INT NOT NULL,
        specialty_id INT NOT NULL,
        CONSTRAINT PK_vet_specialties PRIMARY KEY (vet_id, specialty_id),
        CONSTRAINT FK_vet_specialties_vet FOREIGN KEY(vet_id) REFERENCES vets(id),
        CONSTRAINT FK_vet_specialties_specialty FOREIGN KEY(specialty_id) REFERENCES specialties(id)
    );
    GO

    CREATE TABLE visits (
        id INT IDENTITY(1,1) PRIMARY KEY,
        pet_id INT NOT NULL,
        visit_date DATE,
        description NVARCHAR(8192),
        CONSTRAINT FK_visits_pet FOREIGN KEY(pet_id) REFERENCES pets(id)
    );
    GO

    INSERT INTO types (name) VALUES ('cat'),('dog'),('lizard'),('snake'),('bird'),('hamster');
    INSERT INTO owners (first_name,last_name,address,city,telephone) VALUES
    ('George','Franklin','110 W. Liberty St.','Madison','6085551023'),
    ('Betty','Davis','638 Cardinal Ave.','Sun Prairie','6085551749'),
    ('Eduardo','Rodriquez','2693 Commerce St.','McFarland','6085558763'),
    ('Harold','Davis','563 Friendly St.','Windsor','6085553198'),
    ('Peter','McTavish','2387 S. Fair Way','Madison','6085552765'),
    ('Jean','Coleman','105 N. Lake St.','Monona','6085552654'),
    ('Jeff','Black','1450 Oak Blvd.','Monona','6085555387'),
    ('Maria','Escobito','345 Maple St.','Madison','6085557683'),
    ('David','Schroeder','2749 Blackhawk Trail','Madison','6085559435'),
    ('Carlos','Estaban','2335 Independence La.','Waunakee','6085555487');
    GO

    INSERT INTO pets (name,birth_date,type_id,owner_id) VALUES
    ('Leo','2000-09-07',1,1),
    ('Basil','2002-08-06',6,2),
    ('Rosy','2001-04-17',2,3),
    ('Jewel','2000-03-07',2,3),
    ('Iggy','2000-11-30',3,4),
    ('George','2000-01-20',4,5),
    ('Samantha','1995-09-04',1,6),
    ('Max','1995-09-04',1,6),
    ('Lucky','1999-08-06',5,7),
    ('Mulligan','1997-02-24',2,8),
    ('Freddy','2000-03-09',5,9),
    ('Lucky','2000-06-24',2,10),
    ('Sly','2002-06-08',1,10);
    GO

    INSERT INTO vets (first_name,last_name) VALUES
    ('James','Carter'),
    ('Helen','Leary'),
    ('Linda','Douglas'),
    ('Rafael','Ortega'),
    ('Henry','Stevens'),
    ('Sharon','Jenkins');
    GO

    INSERT INTO specialties (name) VALUES ('radiology'),('surgery'),('dentistry');
    GO

    INSERT INTO vet_specialties (vet_id,specialty_id) VALUES (2,1),(3,2),(3,3),(4,2),(5,1);
    GO

    INSERT INTO visits (pet_id,visit_date,description) VALUES
    (7,'2010-03-04','rabies shot'),
    (8,'2011-03-04','rabies shot'),
    (8,'2009-06-04','neutered'),
    (7,'2008-09-04','spayed');
    GO
